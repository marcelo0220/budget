<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Budget Pro AI+ ‚úÖ BUDGET MODIFIABLE + ALERTES</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--primary:#3f51b5;--accent:#ffd700;--glass:rgba(255,255,255,0.1);--success:#4ecdc4;--warning:#ff6b6b;--danger:#ef4444;--bg-dark:linear-gradient(135deg,#0a0e17,#1a237e);--radius:16px}
body{font-family:'Inter',sans-serif;background:var(--bg-dark);color:#fff;min-height:100vh}
.light{--glass:rgba(0,0,0,0.1);background:#e0e0e0;color:#2d3748}
.container{max-width:1200px;margin:auto;padding:20px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
h1{font-size:28px;font-weight:700;background:linear-gradient(135deg,#fff,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.theme-toggle{width:50px;height:50px;border-radius:50%;background:var(--glass);border:2px solid rgba(255,255,255,0.3);cursor:pointer;font-size:20px;transition:all 0.3s}
.balance-card{background:var(--glass);backdrop-filter:blur(20px);border-radius:20px;padding:24px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.15)}
.balance-label{font-size:14px;font-weight:600;opacity:0.9;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.balance-amount{font-size:32px;font-weight:700;margin:12px 0;background:linear-gradient(135deg,#fff,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin:20px 0}
.stat-card{background:var(--glass);padding:20px;border-radius:16px;border:1px solid rgba(255,255,255,0.15);text-align:center;transition:all 0.2s;cursor:pointer}
.stat-card:hover{transform:translateY(-4px)}
.actions{display:flex;gap:12px;margin:20px 0;flex-wrap:wrap}
.btn{flex:1;min-width:120px;padding:14px;border:none;border-radius:14px;font-weight:600;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:8px;position:relative;z-index:10}
.btn-primary{background:var(--primary);color:#fff}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(63,81,181,0.4)}
.btn-secondary{background:var(--glass);border:2px solid rgba(255,255,255,0.3);color:#fff}
.btn-secondary:hover{background:rgba(255,255,255,0.2)}
.search-box{width:100%;padding:16px;border-radius:14px;border:2px solid rgba(255,255,255,0.2);background:var(--glass);color:#fff;font-size:16px;margin-bottom:20px}
.search-box:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,215,0,0.2)}
.transactions{background:var(--glass);padding:24px;border-radius:20px;border:1px solid rgba(255,255,255,0.15);margin-bottom:20px}
.transaction-item{display:flex;justify-content:space-between;align-items:center;padding:16px;border-radius:14px;margin-bottom:12px;background:rgba(255,255,255,0.08);cursor:pointer;transition:all 0.2s;position:relative;z-index:10}
.transaction-item:hover{background:rgba(255,255,255,0.15);transform:translateX(4px)}
.transaction-info{display:flex;gap:14px;align-items:center;flex:1}
.transaction-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px}
.transaction-amount{font-size:18px;font-weight:700}
.positive{color:var(--success)}
.negative{color:var(--warning)}
.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center;padding:20px}
.modal.active{display:flex}
.modal-content{background:#fff;color:#1a237e;width:100%;max-width:500px;border-radius:20px;padding:30px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.5);animation:slideIn 0.3s}
@keyframes slideIn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
.form-group{margin-bottom:18px}
.form-group label{font-weight:600;font-size:15px;display:block;margin-bottom:8px}
.form-group input,.form-group select{width:100%;padding:14px;border-radius:12px;border:2px solid rgba(26,35,126,0.2);font-size:16px;background:#fff}
.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(63,81,181,0.1)}
.category-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(70px,1fr));gap:12px;margin-top:12px}
.category-btn{padding:16px;border-radius:14px;border:2px solid rgba(26,35,126,0.3);cursor:pointer;font-size:24px;text-align:center;transition:all 0.2s;background:rgba(255,255,255,0.1);position:relative;z-index:10}
.category-btn:hover{transform:scale(1.05);background:rgba(63,81,181,0.2)}
.category-btn.active{border-color:var(--accent);background:rgba(255,215,0,0.3);transform:scale(1.1)}
.cat-info{font-size:13px;margin-top:8px;padding:12px;background:rgba(63,81,181,0.1);border-radius:10px;border-left:4px solid var(--accent)}
.profile-badges{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
.profile-badge{padding:12px 16px;border-radius:25px;border:2px solid rgba(255,255,255,0.4);font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:6px;position:relative;z-index:10}
.profile-badge:hover{background:rgba(255,255,255,0.2);transform:translateY(-2px)}
.profile-badge.active{background:rgba(255,215,0,0.3);border-color:var(--accent)}
.chart-container{background:var(--glass);border-radius:20px;padding:20px;margin:20px 0;border:1px solid rgba(255,255,255,0.15)}
.toast{position:fixed;top:24px;right:calc(24px + var(--scrollbar-width, 0px));background:var(--success);color:#fff;padding:16px 24px;border-radius:12px;z-index:2000;font-weight:600;cursor:pointer;transform:translateX(400px);transition:all 0.4s}
.toast.show{transform:translateX(0)}
.suggestion-item{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid rgba(255,255,255,0.1);transition:all 0.2s;cursor:pointer}
.suggestion-item:hover{background:rgba(255,255,255,0.1)}
.suggestion-item input{width:140px;padding:10px;border-radius:10px;border:2px solid rgba(255,215,0,0.5);background:#fff;color:#000;font-size:14px;text-align:right;font-weight:600}
.suggestion-item input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,215,0,0.2)}
.budget-ok{border-color:var(--success)!important;background:var(--success)15!important}
.budget-warning{border-color:var(--warning)!important;background:var(--warning)20!important}
.budget-danger{border-color:var(--danger)!important;background:var(--danger)25!important}
.spent-info{font-size:12px;opacity:0.8;margin-top:4px}
.progress-bar{width:80px;height:6px;background:rgba(255,255,255,0.2);border-radius:3px;overflow:hidden;display:inline-block;margin-left:8px;vertical-align:middle}
.progress-fill{height:100%;transition:width 0.5s ease;border-radius:3px}
.progress-ok{background:var(--success)}
.progress-warning{background:var(--warning)}
.progress-danger{background:var(--danger)}
.switch{position:relative;display:inline-block;width:60px;height:34px}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;transition:0.4s;border-radius:34px}
.slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background:#fff;transition:0.4s;border-radius:50%}
input:checked+.slider{background:var(--primary)}
input:checked+.slider:before{transform:translateX(26px)}
@media(max-width:768px){
.actions{flex-direction:column}
.btn{flex:1}
.header{display:flex;flex-direction:column;gap:16px;text-align:center}
.balance-card{padding:16px}
.stats-grid{grid-template-columns:repeat(2,1fr);gap:12px}
.transaction-item{padding:12px}
.modal-content{max-width:90%;padding:20px}
.form-group input,.form-group select{padding:12px}
.category-grid{grid-template-columns:repeat(4,1fr)}
}

@media(max-width:576px){
h1{font-size:24px}
.balance-amount{font-size:24px}
.stats-grid{grid-template-columns:1fr;gap:8px}
.stat-card{padding:16px}
.actions{gap:8px}
.btn{min-height:48px;padding:12px;font-size:16px}
.search-box{padding:12px;font-size:14px;margin-bottom:16px}
.transactions{padding:16px}
.transaction-item{padding:10px;margin-bottom:8px}
.transaction-icon{width:36px;height:36px;font-size:18px}
.transaction-amount{font-size:16px}
.modal-content{max-width:95%;padding:16px}
.form-group{margin-bottom:14px}
.form-group input,.form-group select{padding:10px;font-size:14px}
.category-btn{padding:12px;font-size:20px}
.profile-badges{flex-direction:column;gap:8px}
.profile-badge{padding:10px 14px;font-size:12px}
.chart-container{padding:16px;margin:16px 0}
.toast{top:16px;right:16px;left:16px;padding:12px 16px;font-size:14px}
}

@media(max-width:480px){
.container{padding:16px}
header{margin-bottom:16px}
h1{font-size:20px}
.balance-card{padding:12px;margin-bottom:16px}
.balance-label{font-size:12px}
.balance-amount{font-size:20px;margin:8px 0}
.stats-grid{gap:6px}
.stat-card{padding:12px}
.actions{gap:6px}
.btn{min-height:44px;padding:10px;font-size:14px}
.search-box{padding:10px;font-size:13px;margin-bottom:12px}
.chart-container{padding:12px;margin:12px 0}
.transactions{padding:12px;margin-bottom:12px}
.transaction-item{padding:8px;margin-bottom:6px}
.transaction-info{gap:10px}
.transaction-icon{width:32px;height:32px;font-size:16px}
.transaction-amount{font-size:14px}
.modal-content{max-width:100%;padding:12px;border-radius:16px}
.form-group{margin-bottom:12px}
.form-group input,.form-group select{padding:8px;font-size:13px}
.category-grid{grid-template-columns:repeat(3,1fr);gap:8px}
.category-btn{padding:10px;font-size:18px}
.cat-info{font-size:12px;padding:8px}
.profile-badges{gap:6px}
.profile-badge{padding:8px 12px;font-size:11px}
.toast{top:12px;left:50%;transform:translateX(-50%);padding:10px 14px;font-size:13px;max-width:calc(100% - 24px)}
.suggestion-item{padding:12px}
.suggestion-item input{width:120px;padding:8px;font-size:13px}
.progress-bar{width:60px}
.spent-info{font-size:11px}
}

/* FIX FOR FAB POSITIONING ON SMALL SCREENS */
@media(max-width:767px){
:root{--scrollbar-width:0px}
.fab{bottom:90px}
}
#logo img{height:40px;width:auto;vertical-align:middle;margin-right:10px;border-radius: 50%;}

/* BOTTOM NAVIGATION */
.section{display:none;opacity:0;transform:translateY(20px);transition:all 0.4s ease}
.section.active{display:block;opacity:1;transform:translateY(0)}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--glass);backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,0.15);z-index:1000;display:flex}
.nav-item{flex:1;padding:12px;text-align:center;cursor:pointer;transition:all 0.3s;font-size:12px;color:rgba(255,255,255,0.7);display:flex;flex-direction:column;align-items:center;gap:4px}
.nav-item.active{color:var(--accent);transform:scale(1.05)}
.nav-item:hover{color:#fff;transform:scale(1.05)}
.nav-icon{font-size:20px}
.container{padding-bottom:80px}

/* FLOATING ACTION BUTTON */
.fab{position:fixed;bottom:100px;right:calc(20px + var(--scrollbar-width, 0px));width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;border:none;font-size:24px;cursor:pointer;z-index:1001;box-shadow:0 4px 20px rgba(63,81,181,0.4);transition:all 0.3s}
.fab:hover{transform:scale(1.1);box-shadow:0 6px 25px rgba(63,81,181,0.6)}
.fab:active{transform:scale(0.95)}
</style>
</head>
<body>
<div class="container">
<header>
<h1><span id="logo"><img src="logo.png"></span> Budget Pro</h1>
<button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">üåô</button>
</header>

<!-- HOME SECTION -->
<div id="home-section" class="section active">
<!-- WELCOME CARD -->
<div class="balance-card">
<h3 style="margin-bottom:8px">üëã Bienvenue sur Budget Pro</h3>
<p style="font-size:14px;opacity:0.8;margin:0">G√©rez votre budget intelligemment avec des suggestions personnalis√©es, des alertes et un suivi en temps r√©el de vos finances.</p>
</div>

<!-- STATS -->
<div class="stats-grid">
<div class="stat-card"><div class="balance-label">üí∞ Budget total</div><div class="balance-amount" id="totalBudget">0 Ar</div></div>
<div class="stat-card"><div class="balance-label">üíµ Solde actuel</div><div class="balance-amount" id="balance">0 Ar</div></div>
<div class="stat-card"><div class="balance-label">üíé √âpargne</div><div class="balance-amount" id="savings">0 Ar</div></div>
<div class="stat-card"><div class="balance-label">‚ö†Ô∏è Reste √† vivre</div><div class="balance-amount" id="resteAVivre">0 Ar</div></div>
</div>

<!-- ACTIONS -->
<div class="actions">
<button class="btn btn-primary" onclick="openModal()">‚ûï Nouvelle transaction</button>
<button class="btn btn-secondary" onclick="undo()">‚Ü∂ Annuler</button>
<button class="btn btn-secondary" onclick="redo()">‚Ü∑ Refaire</button>
<button class="btn btn-secondary" onclick="exportData()">üìä Exporter</button>
<button class="btn btn-secondary" onclick="resetData()">üßπ Reset</button>
<button class="btn btn-secondary" onclick="generateReport()">üìà Rapport</button>
</div>

<!-- CHART -->
<div class="chart-container">
<canvas id="expensesChart" width="400" height="200"></canvas>
</div>

<!-- SUGGESTIONS avec ALERTES -->
<div class="balance-card">
<h3 style="margin-bottom:16px">üí° Budget sugg√©r√© <span style="font-size:14px;opacity:0.7">(modifiable + alertes)</span></h3>
<div id="suggestionList"></div>
</div>
</div>

<!-- SETTINGS SECTION -->
<div id="settings-section" class="section">
<!-- CONFIG -->
<div class="balance-card">
<div class="balance-label">‚öôÔ∏è Configuration</div>
<div class="form-group">
<label>Budget mensuel (Ar)</label>
<input type="number" id="monthlyBudget" min="0" placeholder="500000" oninput="saveConfig()">
</div>
<div class="form-group">
<label>Personnes au foyer</label>
<input type="number" id="peopleCount" min="1" value="1" max="10" oninput="saveConfig()">
</div>
<div class="form-group">
<label>Paye loyer?</label>
<div style="display:flex;align-items:center;gap:12px">
<input type="checkbox" id="payRent" onchange="saveConfig()">
<span style="font-size:14px">Oui</span>
</div>
</div>
<div class="form-group">
<label>Profil</label>
<div class="profile-badges">
<button class="profile-badge active" onclick="selectProfile('balanced')">‚öñÔ∏è √âquilibr√©</button>
<button class="profile-badge" onclick="selectProfile('security')">üõ°Ô∏è S√©curit√©</button>
<button class="profile-badge" onclick="selectProfile('comfort')">üéâ Confort</button>
</div>
</div>
</div>

<!-- ADDITIONAL SETTINGS -->
<div class="balance-card">
<h3 style="margin-bottom:16px">üé® Apparence</h3>
<div class="form-group">
<label>Th√®me</label>
<div style="display:flex;gap:12px">
<button class="btn btn-secondary" onclick="toggleTheme()">üåô Basculer th√®me</button>
</div>
</div>
</div>

<div class="balance-card">
<h3 style="margin-bottom:16px">üíæ Donn√©es</h3>
<div class="actions">
<button class="btn btn-secondary" onclick="exportData()">üìä Exporter</button>
<button class="btn btn-secondary" onclick="resetData()">üßπ Reset</button>
</div>
</div>
</div>

<!-- BALANCE SECTION -->
<div id="balance-section" class="section">
<!-- STATS -->
<div class="stats-grid">
<div class="stat-card"><div class="balance-label">üí∞ Budget total</div><div class="balance-amount" id="totalBudget2">0 Ar</div></div>
<div class="stat-card"><div class="balance-label">üíµ Solde actuel</div><div class="balance-amount" id="balance2">0 Ar</div></div>
<div class="stat-card"><div class="balance-label">üíé √âpargne</div><div class="balance-amount" id="savings2">0 Ar</div></div>
<div class="stat-card"><div class="balance-label">‚ö†Ô∏è Reste √† vivre</div><div class="balance-amount" id="resteAVivre2">0 Ar</div></div>
</div>

<input class="search-box" id="searchInput" placeholder="üîç Recherche transactions..." oninput="renderTransactions()">

<!-- TRANSACTIONS -->
<div class="transactions">
<h3 style="margin-bottom:20px">üìã Transactions r√©centes</h3>
<div id="transactionsList">Aucune transaction</div>
</div>
</div>

<!-- OBJECTIVES SECTION -->
<div id="objectives-section" class="section">
<!-- OBJECTIFS -->
<div class="balance-card">
<h3 style="margin-bottom:16px">üéØ Objectifs d'√©pargne</h3>
<div id="goalsList"></div>
<button class="btn btn-secondary" onclick="openGoalModal()">‚ûï Nouveau objectif</button>
</div>
</div>
</div>

<!-- BOTTOM NAVIGATION -->
<div class="bottom-nav">
<a href="#" class="nav-item active" onclick="showSection('home-section', event); return false;">
<div class="nav-icon">üè†</div>
<span>Accueil</span>
</a>
<a href="#" class="nav-item" onclick="showSection('balance-section', event); return false;">
<div class="nav-icon">üí∞</div>
<span>Solde</span>
</a>
<a href="#" class="nav-item" onclick="showSection('objectives-section', event); return false;">
<div class="nav-icon">üéØ</div>
<span>Objectifs</span>
</a>
<a href="#" class="nav-item" onclick="showSection('settings-section', event); return false;">
<div class="nav-icon">‚öôÔ∏è</div>
<span>Param√®tres</span>
</a>
</div>

<!-- FLOATING ACTION BUTTON -->
<button class="fab" onclick="openModal()">‚ûï</button>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- MODAL -->
<div class="modal" id="transactionModal">
<div class="modal-content">
<h2 id="modalTitle">‚ûï Nouvelle transaction</h2>
<form onsubmit="addTransaction(event)">
<div class="form-group">
<label>Type</label>
<select id="transactionType" onchange="updateCategories()">
<option value="expense">üí∏ D√©pense</option>
<option value="income">üí∞ Revenu</option>
</select>
</div>
<div class="form-group">
<label>Montant (Ar)</label>
<input type="number" id="amount" required min="0" placeholder="15000">
</div>
<div class="form-group">
<label>Description</label>
<input type="text" id="description" required placeholder="Courses, salaire...">
</div>
<div class="form-group">
<label>Cat√©gorie</label>
<div class="category-grid" id="categoryGrid"></div>
<div id="categoryInfo" class="cat-info">‚ö†Ô∏è Cliquez sur une ic√¥ne</div>
</div>
<div style="display:flex;gap:16px">
<button class="btn btn-primary" type="submit">‚úÖ Enregistrer</button>
<button type="button" class="btn btn-secondary" onclick="closeModal()">‚ùå Annuler</button>
</div>
</form>
</div>
</div>

<!-- GOAL MODAL -->
<div class="modal" id="goalModal">
<div class="modal-content">
<h2 id="goalModalTitle">üéØ Nouveau objectif</h2>
<form onsubmit="addGoal(event)">
<div class="form-group">
<label>Nom de l'objectif</label>
<input type="text" id="goalName" required placeholder="Moto, voyage...">
</div>
<div class="form-group">
<label>Montant cible (Ar)</label>
<input type="number" id="goalTarget" required min="0" placeholder="500000">
</div>
<div class="form-group">
<label>Date limite</label>
<input type="date" id="goalDeadline" required>
</div>
<div style="display:flex;gap:16px">
<button class="btn btn-primary" type="submit">‚úÖ Cr√©er</button>
<button type="button" class="btn btn-secondary" onclick="closeGoalModal()">‚ùå Annuler</button>
</div>
</form>
</div>
</div>

<script>
// VARIABLES GLOBALES
let transactions = JSON.parse(localStorage.getItem('budgetProTransactions') || '[]');
let savings = parseFloat(localStorage.getItem('budgetProSavings') || '0');
let monthlyBudget = Number(localStorage.getItem('budgetProMonthly') || 0);
let peopleCount = Number(localStorage.getItem('budgetProPeople') || 1);
let payRent = localStorage.getItem('budgetProRent') === 'true';
let selectedProfile = localStorage.getItem('budgetProProfile') || 'balanced';
let selectedCategory = -1;
let chart = null;
let customBudget = JSON.parse(localStorage.getItem('budgetProCustomBudget') || '{}');
let goals = JSON.parse(localStorage.getItem('budgetProGoals') || '[]');
let history = [];
let historyIndex = -1;
let toastTimeout;

// INIT
document.addEventListener('DOMContentLoaded', function() {
loadUI();
renderAll();
saveState();

// Calculate scrollbar width and set CSS variable
const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
document.documentElement.style.setProperty('--scrollbar-width', scrollbarWidth + 'px');
});

function formatAr(v) {
return new Intl.NumberFormat('fr-FR').format(Math.round(v)) + ' Ar';
}

function showToast(message) {
const toast = document.getElementById('toast');
toast.textContent = message;
toast.style.display = 'block';
toast.classList.add('show');
if (toastTimeout) clearTimeout(toastTimeout);
toastTimeout = setTimeout(() => hideToast(), 3000);
toast.onclick = () => {
if (toastTimeout) clearTimeout(toastTimeout);
toast.classList.remove('show');
toast.style.display = 'none';
};
}

function hideToast() {
const toast = document.getElementById('toast');
toast.classList.remove('show');
toast.style.transform = 'translateX(400px)';
setTimeout(() => {
toast.style.display = 'none';
toast.style.transform = '';
}, 400);
}

function getTotalBudget() {
const income = transactions.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
return monthlyBudget + income;
}

function getSpentByCategory(category) {
return Math.abs(transactions
.filter(t => t.category === category && t.amount < 0)
.reduce((sum, t) => sum + Math.abs(t.amount), 0));
}

function getCategoryIcon(cat) {
const icons = {
'Nourriture': 'üçî', 'Transport': 'üöó', 'Logement': 'üè†', '√âpargne': 'üíé',
'Sant√©': '‚ù§Ô∏è', 'Internet': 'üì±', '√ânergie': 'üí°', 'Loisirs': 'üéâ', 'Business': 'üìà'
};
return icons[cat] || 'üìä';
}

function loadUI() {
document.getElementById('monthlyBudget').value = monthlyBudget;
document.getElementById('peopleCount').value = peopleCount;
document.getElementById('payRent').checked = payRent;
document.querySelectorAll('.profile-badge').forEach(btn => {
const profile = btn.textContent.includes('√âquilibr√©') ? 'balanced' :
btn.textContent.includes('S√©curit√©') ? 'security' : 'comfort';
btn.classList.toggle('active', profile === selectedProfile);
});
const isLight = localStorage.getItem('budgetProTheme') === 'light';
if (isLight) document.body.classList.add('light');
document.getElementById('themeToggle').textContent = isLight ? 'üåô' : '‚òÄÔ∏è';
}

function toggleTheme() {
document.body.classList.toggle('light');
const isLight = document.body.classList.contains('light');
localStorage.setItem('budgetProTheme', isLight ? 'light' : 'dark');
document.getElementById('themeToggle').textContent = isLight ? 'üåô' : '‚òÄÔ∏è';
showToast('Th√®me chang√© !');
}

function selectProfile(profile) {
selectedProfile = profile;
localStorage.setItem('budgetProProfile', profile);
document.querySelectorAll('.profile-badge').forEach(btn => btn.classList.remove('active'));
event.target.classList.add('active');
renderSuggestions();
renderAll();
showToast(`Profil ${profile} activ√©`);
}

function saveConfig() {
monthlyBudget = Number(document.getElementById('monthlyBudget').value) || 0;
peopleCount = Number(document.getElementById('peopleCount').value) || 1;
payRent = document.getElementById('payRent').checked;
localStorage.setItem('budgetProMonthly', monthlyBudget);
localStorage.setItem('budgetProPeople', peopleCount);
localStorage.setItem('budgetProRent', payRent);
renderAll();
showToast('Config sauvegard√©e');
}

function getCategories(type) {
return type === 'expense' ?
[{icon:'üçî',name:'Nourriture',color:'#ff6b6b'},{icon:'üöó',name:'Transport',color:'#4ecdc4'},{icon:'üè†',name:'Logement',color:'#95e1d3'},{icon:'üì±',name:'Internet',color:'#ffd93d'},{icon:'üí°',name:'√ânergie',color:'#f8b400'},{icon:'‚ù§Ô∏è',name:'Sant√©',color:'#ff9ff3'},{icon:'üéØ',name:'Objectifs',color:'#a29bfe'}] :
[{icon:'üí∞',name:'Salaire',color:'#4ecdc4'},{icon:'üìà',name:'Business',color:'#ffd93d'},{icon:'üéÅ',name:'Autres',color:'#95e1d3'}];
}

function updateCategories() {
const type = document.getElementById('transactionType').value;
const cats = getCategories(type);
document.getElementById('categoryGrid').innerHTML = cats.map((c, i) =>
`<button class="category-btn ${i === selectedCategory ? 'active' : ''}" onclick="selectCategory(${i})" title="${c.name}">${c.icon}</button>`
).join('');
const info = document.getElementById('categoryInfo');
info.textContent = selectedCategory >= 0 && selectedCategory < cats.length ?
`‚úÖ ${cats[selectedCategory].name}` : '‚ö†Ô∏è Cliquez sur une ic√¥ne';
}

function selectCategory(index) {
selectedCategory = index;
updateCategories();
}

function openModal() {
document.getElementById('transactionModal').classList.add('active');
document.getElementById('amount').value = '';
document.getElementById('description').value = '';
selectedCategory = -1;
document.getElementById('transactionType').value = 'expense';
document.getElementById('modalTitle').textContent = '‚ûï Nouvelle transaction';
updateCategories();
document.body.style.overflow = 'hidden';
}

function closeModal() {
document.getElementById('transactionModal').classList.remove('active');
document.body.style.overflow = '';
}

function addTransaction(e) {
e.preventDefault();
if (selectedCategory === -1) {
showToast('‚ö†Ô∏è Choisissez une cat√©gorie', 'warning');
return;
}
saveState();
const type = document.getElementById('transactionType').value;
const amount = Number(document.getElementById('amount').value);
const desc = document.getElementById('description').value;
const cats = getCategories(type);
const cat = cats[selectedCategory];
let value = type === 'expense' ? -amount : amount;

if (type === 'income') {
const savingsAdded = Math.min(amount * 0.2, 50000);
savings += savingsAdded;
value -= savingsAdded;
localStorage.setItem('budgetProSavings', savings);
}

transactions.unshift({
id: Date.now(),
amount: value,
description: desc,
icon: cat.icon,
category: cat.name,
color: cat.color,
date: new Date().toISOString()
});

localStorage.setItem('budgetProTransactions', JSON.stringify(transactions));
closeModal();
renderAll();
showToast('‚úÖ Transaction ajout√©e');
}

function renderTransactions() {
const search = document.getElementById('searchInput').value.toLowerCase();
const filtered = transactions
.filter(t => t.description.toLowerCase().includes(search) || t.category.toLowerCase().includes(search))
.slice(0, 10);

document.getElementById('transactionsList').innerHTML = filtered.length ?
filtered.map(t => {
const isPositive = t.amount > 0;
return `
<div class="transaction-item" onclick="deleteTransaction(${t.id})">
<div class="transaction-info">
<div class="transaction-icon" style="background:${t.color}30">${t.icon}</div>
<div>
<strong>${t.description}</strong>
<br><small>${t.category} ¬∑ ${new Date(t.date).toLocaleDateString('fr-FR')}</small>
</div>
</div>
<div class="transaction-amount ${isPositive ? 'positive' : 'negative'}">
${isPositive ? '+' : ''}${formatAr(Math.abs(t.amount))}
</div>
</div>`;
}).join('') : '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">üì≠ Aucune transaction trouv√©e</div>';
}

function updateStats() {
const balance = transactions.reduce((s, t) => s + t.amount, 0);
const resteAVivre = balance - savings;
const minReste = 50000 * peopleCount;

document.getElementById('totalBudget').textContent = formatAr(getTotalBudget());
document.getElementById('balance').textContent = formatAr(balance);
document.getElementById('savings').textContent = formatAr(savings);
document.getElementById('resteAVivre').textContent = formatAr(resteAVivre);
document.getElementById('resteAVivre').style.color = resteAVivre < minReste ? '#ff6b6b' : '#4ecdc4';

// Update balance section stats
document.getElementById('totalBudget2').textContent = formatAr(getTotalBudget());
document.getElementById('balance2').textContent = formatAr(balance);
document.getElementById('savings2').textContent = formatAr(savings);
document.getElementById('resteAVivre2').textContent = formatAr(resteAVivre);
document.getElementById('resteAVivre2').style.color = resteAVivre < minReste ? '#ff6b6b' : '#4ecdc4';
}

function renderSuggestions() {
const total = getTotalBudget();
if (total <= 0) {
document.getElementById('suggestionList').innerHTML =
'<div style="text-align:center;padding:20px;color:rgba(255,255,255,0.6)">üí° Entrez un budget pour les suggestions</div>';
return;
}

const profiles = {
balanced: {Nourriture:0.25, Transport:0.12, Logement:payRent?0.35:0, √âpargne:0.20, Sant√©:0.08},
security: {Nourriture:0.30, Transport:0.10, Logement:payRent?0.30:0, √âpargne:0.25, Sant√©:0.10},
comfort: {Nourriture:0.22, Transport:0.15, Logement:payRent?0.38:0, √âpargne:0.15, Loisirs:0.10}
};

const profile = profiles[selectedProfile];
let html = '';

Object.entries(profile).forEach(([cat, pct]) => {
if (pct <= 0) return;

const suggested = Math.round(total * pct);
const budgeted = customBudget[cat] != null ? customBudget[cat] : suggested;
const spent = getSpentByCategory(cat);
const percentUsed = budgeted > 0 ? (spent / budgeted * 100) : 0;

let statusClass = 'budget-ok';
let statusText = '‚úÖ OK';
let progressClass = 'progress-ok';

if (percentUsed > 90) {
statusClass = 'budget-danger';
statusText = 'üö® D√âPASSE';
progressClass = 'progress-danger';
} else if (percentUsed > 75) {
statusClass = 'budget-warning';
statusText = '‚ö†Ô∏è ATTENTION';
progressClass = 'progress-warning';
}

html += `
<div class="suggestion-item ${statusClass}" onclick="this.querySelector('input').focus()">
<div style="display:flex;align-items:center;gap:8px;flex:1">
<span style="font-size:16px">${getCategoryIcon(cat)}</span>
<div>
<div style="font-weight:600">${cat}</div>
<div class="spent-info">D√©pens√©: ${formatAr(spent)} (${Math.round(percentUsed)}%)</div>
</div>
</div>
<div style="display:flex;align-items:center;gap:12px">
<input
type="number"
value="${budgeted}"
min="0"
onchange="updateCustomBudget('${cat}', this.value)"
class="budget-input"
placeholder="${formatAr(suggested)}"
>
<div class="progress-bar">
<div class="progress-fill ${progressClass}" style="width:${Math.min(percentUsed,100)}%"></div>
</div>
<span style="font-weight:700;min-width:80px">${statusText}</span>
</div>
</div>`;
});

document.getElementById('suggestionList').innerHTML = html;
}

function updateCustomBudget(category, value) {
customBudget[category] = Number(value) || 0;
localStorage.setItem('budgetProCustomBudget', JSON.stringify(customBudget));
renderSuggestions();
renderAll();
showToast(`üí∞ Budget ${category} : ${formatAr(Number(value))}`);
}

function updateChart() {
const ctx = document.getElementById('expensesChart').getContext('2d');
if (chart) chart.destroy();

const expenses = {};
transactions.filter(t => t.amount < 0).forEach(t => {
expenses[t.category] = (expenses[t.category] || 0) + Math.abs(t.amount);
});

chart = new Chart(ctx, {
type: 'doughnut',
data: {
labels: Object.keys(expenses),
datasets: [{
data: Object.values(expenses),
backgroundColor: ['#ff6b6b','#4ecdc4','#95e1d3','#ffd93d','#f8b400','#ff9ff3']
}]
},
options: {
responsive: true,
plugins: {legend: {position: 'bottom'}}
}
});
}

function renderAll() {
updateStats();
renderTransactions();
renderSuggestions();
renderGoals();
updateChart();
}

function deleteTransaction(id) {
if (confirm('Supprimer cette transaction ?')) {
saveState();
transactions = transactions.filter(t => t.id !== id);
localStorage.setItem('budgetProTransactions', JSON.stringify(transactions));
renderAll();
showToast('üóëÔ∏è Supprim√©e');
}
}

function exportData() {
const data = {
transactions,
savings,
customBudget,
config: {monthlyBudget, peopleCount, payRent, selectedProfile}
};
const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = 'budget-pro.json';
a.click();
URL.revokeObjectURL(url);
showToast('üìä Export√© avec budgets personnalis√©s !');
}

function resetData() {
if (confirm('Tout r√©initialiser ?')) {
transactions = [];
savings = 0;
customBudget = {};
localStorage.clear();
renderAll();
showToast('üßπ Reset complet');
}
}

function generateReport() {
const balance = transactions.reduce((s, t) => s + t.amount, 0);
const income = transactions.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
const expenses = Math.abs(transactions.filter(t => t.amount < 0).reduce((s, t) => s + t.amount, 0));
showToast(`üìä RAPPORT:\nRevenus: ${formatAr(income)}\nD√©penses: ${formatAr(expenses)}\nSolde: ${formatAr(balance)}`);
}

function openGoalModal() {
document.getElementById('goalModal').classList.add('active');
document.getElementById('goalName').value = '';
document.getElementById('goalTarget').value = '';
document.getElementById('goalDeadline').value = '';
document.getElementById('goalModalTitle').textContent = 'üéØ Nouveau objectif';
document.body.style.overflow = 'hidden';
}

function closeGoalModal() {
document.getElementById('goalModal').classList.remove('active');
document.body.style.overflow = '';
}

function addGoal(e) {
e.preventDefault();
saveState();
const name = document.getElementById('goalName').value;
const target = Number(document.getElementById('goalTarget').value);
const deadline = document.getElementById('goalDeadline').value;

goals.push({
id: Date.now(),
name,
target,
current: 0,
deadline,
created: new Date().toISOString()
});

localStorage.setItem('budgetProGoals', JSON.stringify(goals));
closeGoalModal();
renderGoals();
showToast('üéØ Objectif ajout√©');
}

function renderGoals() {
if (goals.length === 0) {
document.getElementById('goalsList').innerHTML = '<div style="text-align:center;padding:20px;color:rgba(255,255,255,0.6)">Aucun objectif d√©fini</div>';
return;
}

let html = '';
goals.forEach(goal => {
const progress = goal.target > 0 ? (goal.current / goal.target * 100) : 0;
const daysLeft = Math.ceil((new Date(goal.deadline) - new Date()) / (1000 * 60 * 60 * 24));
const isOverdue = daysLeft < 0;
const status = isOverdue ? '‚è∞ En retard' : daysLeft <= 7 ? '‚ö†Ô∏è Bient√¥t' : '‚úÖ OK';

html += `
<div class="goal-item" style="background:rgba(255,255,255,0.08);padding:16px;border-radius:14px;margin-bottom:12px;">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
<div style="font-weight:600">${goal.name}</div>
<div style="font-size:12px;color:${isOverdue ? '#ff6b6b' : '#4ecdc4'}">${status}</div>
</div>
<div style="margin-bottom:8px;">
<div style="display:flex;justify-content:space-between;font-size:14px;margin-bottom:4px;">
<span>Progression: ${formatAr(goal.current)} / ${formatAr(goal.target)}</span>
<span>${Math.round(progress)}%</span>
</div>
<div class="progress-bar">
<div class="progress-fill ${progress >= 100 ? 'progress-ok' : progress > 50 ? 'progress-warning' : 'progress-danger'}" style="width:${Math.min(progress,100)}%"></div>
</div>
</div>
<div style="display:flex;justify-content:space-between;font-size:12px;opacity:0.8;">
<span>√âch√©ance: ${new Date(goal.deadline).toLocaleDateString('fr-FR')}</span>
<div style="display:flex;gap:8px">
<button onclick="addToGoal(${goal.id})" style="background:#4ecdc4;color:#fff;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;">‚ûï Ajouter</button>
<button onclick="deleteGoal(${goal.id})" style="background:#ff6b6b;color:#fff;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;">üóëÔ∏è Supprimer</button>
</div>
</div>
</div>`;
});

document.getElementById('goalsList').innerHTML = html;
}

function addToGoal(id) {
const amount = prompt('Montant √† ajouter (Ar):');
if (amount && !isNaN(amount)) {
saveState();
const goal = goals.find(g => g.id === id);
if (goal) {
goal.current += Number(amount);
localStorage.setItem('budgetProGoals', JSON.stringify(goals));
renderGoals();
showToast(`‚ûï ${formatAr(Number(amount))} ajout√© √† ${goal.name}`);
}
}
}

function deleteGoal(id) {
if (confirm('Supprimer cet objectif ?')) {
saveState();
goals = goals.filter(g => g.id !== id);
localStorage.setItem('budgetProGoals', JSON.stringify(goals));
renderGoals();
showToast('üóëÔ∏è Objectif supprim√©');
}
}

function saveState() {
const state = {
transactions: JSON.parse(JSON.stringify(transactions)),
goals: JSON.parse(JSON.stringify(goals)),
savings: savings
};
historyIndex++;
if (historyIndex < history.length) {
history = history.slice(0, historyIndex);
}
history.push(state);
if (history.length > 50) {
history.shift();
historyIndex--;
}
}

function undo() {
if (historyIndex > 0) {
historyIndex--;
const state = history[historyIndex];
transactions = JSON.parse(JSON.stringify(state.transactions));
goals = JSON.parse(JSON.stringify(state.goals));
savings = state.savings;
localStorage.setItem('budgetProTransactions', JSON.stringify(transactions));
localStorage.setItem('budgetProGoals', JSON.stringify(goals));
localStorage.setItem('budgetProSavings', savings);
renderAll();
showToast('‚Ü∂ Annul√©');
} else {
showToast('‚ùå Rien √† annuler');
}
}

function redo() {
if (historyIndex < history.length - 1) {
historyIndex++;
const state = history[historyIndex];
transactions = JSON.parse(JSON.stringify(state.transactions));
goals = JSON.parse(JSON.stringify(state.goals));
savings = state.savings;
localStorage.setItem('budgetProTransactions', JSON.stringify(transactions));
localStorage.setItem('budgetProGoals', JSON.stringify(goals));
localStorage.setItem('budgetProSavings', savings);
renderAll();
showToast('‚Ü∑ Refait');
} else {
showToast('‚ùå Rien √† refaire');
}
}

function showSection(sectionId, event) {
document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
document.getElementById(sectionId).classList.add('active');
document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
event.target.closest('.nav-item').classList.add('active');
if (sectionId === 'balance-section') {
renderTransactions();
} else if (sectionId === 'objectives-section') {
renderGoals();
}
}
</script>
</body>
</html>
