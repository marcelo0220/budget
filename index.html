<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Budget Pro</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box}

:root{
  --primary:linear-gradient(135deg,#1a237e,#3f51b5);
  --accent:#ffd700;
  --glass:rgba(255,255,255,.1);
  --shadow:0 20px 40px rgba(0,0,0,.2)
}

body{
  font-family:Inter,sans-serif;
  background:linear-gradient(135deg,#0a0e27,#1a237e);
  color:#fff;
  min-height:100vh
}

body.light{
  background:linear-gradient(135deg,#e3f2fd,#bbdefb);
  color:#1a237e
}

.container{max-width:1200px;margin:auto;padding:20px}

header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:30px
}

h1{
  font-size:28px;
  font-weight:700;
  background:linear-gradient(135deg,#fff,var(--accent));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent
}

.theme-toggle{
  width:50px;height:50px;
  border-radius:50%;
  background:var(--glass);
  border:1px solid rgba(255,255,255,.2);
  cursor:pointer;
  font-size:20px
}

.balance-card{
  background:var(--glass);
  backdrop-filter:blur(20px);
  border-radius:24px;
  padding:24px 20px;
  margin-bottom:18px;
  border:1px solid rgba(255,255,255,.2)
}

.balance-label{opacity:.8;font-weight:600;font-size:13px}
.balance-amount{
  font-size:32px;
  font-weight:700;
  margin:10px 0;
  background:linear-gradient(135deg,#fff,var(--accent));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent
}

.stats-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
  gap:15px;
  margin-bottom:20px
}

.stat-card{
  background:var(--glass);
  padding:16px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.2)
}

.stat-label{opacity:.7;font-size:13px}
.stat-value{font-size:20px;font-weight:600}
.positive{color:#4ecdc4}
.negative{color:#ff6b6b}

.actions{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}

.btn{
  flex:1;
  min-width:120px;
  padding:12px;
  border:none;
  border-radius:14px;
  font-weight:600;
  cursor:pointer
}

.btn-primary{background:var(--primary);color:#fff}
.btn-secondary{
  background:var(--glass);
  border:1px solid rgba(255,255,255,.2);
  color:#fff
}

.search-box{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.2);
  background:var(--glass);
  color:#fff;
  margin-bottom:18px
}

.transactions{
  background:var(--glass);
  padding:20px;
  border-radius:24px;
  border:1px solid rgba(255,255,255,.2);
  margin-bottom:18px
}

.transactions h3{
  margin-bottom:10px;
  font-size:18px
}

.transaction-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  border-radius:12px;
  margin-bottom:8px;
  background:rgba(255,255,255,.05);
  cursor:pointer
}

.transaction-info{display:flex;gap:12px;align-items:center}
.transaction-icon{
  width:40px;height:40px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px
}

.transaction-amount{font-size:16px;font-weight:600}

.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.8);
  backdrop-filter:blur(10px);
  align-items:flex-end;
  z-index:20
}

.modal-content{
  background:#fff;
  color:#1a237e;
  width:100%;
  max-width:600px;
  margin:auto;
  border-radius:24px 24px 0 0;
  padding:24px
}

.form-group{margin-bottom:14px}
.form-group label{font-weight:600;font-size:14px;display:block;margin-bottom:4px}
.form-group input,.form-group select{
  width:100%;
  padding:10px;
  border-radius:12px;
  border:2px solid rgba(26,35,126,.2)
}

.category-grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
  margin-top:8px
}

.category-btn{
  padding:10px;
  border-radius:12px;
  border:2px solid rgba(26,35,126,.2);
  cursor:pointer;
  font-size:20px;
  text-align:center
}

.category-btn.active{
  border-color:#3f51b5;
  background:rgba(63,81,181,.15)
}

.toast{
  position:fixed;
  bottom:30px;
  right:30px;
  background:var(--glass);
  padding:18px 24px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.2)
}

/* section enveloppes */
.envelopes{
  background:var(--glass);
  padding:20px;
  border-radius:24px;
  border:1px solid rgba(255,255,255,.2);
  margin-bottom:18px
}

.envelope-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px 0;
  border-bottom:1px solid rgba(255,255,255,.08)
}

.envelope-row:last-child{
  border-bottom:none
}

.envelope-name{font-weight:600;font-size:14px}
.envelope-amount{font-size:14px}
.envelope-warning{color:#ff6b6b;font-size:12px}
</style>
</head>

<body>
<div class="container">

<header>
  <h1>Budget Pro</h1>
  <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ™</button>
</header>

<!-- CONFIG FOYER -->
<div class="balance-card">
  <div class="balance-label">Configuration du foyer</div>
  <div class="form-group" style="margin-top:10px">
    <label>Budget mensuel total (Ar)</label>
    <input type="number" id="monthlyBudget" oninput="saveConfig()" placeholder="Ex : 1 000 000">
  </div>
  <div class="form-group">
    <label>Nombre de personnes au foyer</label>
    <input type="number" id="peopleCount" min="1" value="1" oninput="saveConfig()">
  </div>
  <div class="form-group">
    <label>DÃ©pense nourriture conseillÃ©e</label>
    <div id="foodAdvice" class="balance-label"></div>
  </div>
</div>

<!-- SOLDE -->
<div class="balance-card">
  <div class="balance-label">Solde actuel</div>
  <div class="balance-amount" id="balance">0 Ar</div>
</div>

<!-- Ã‰PARGNE INTELLIGENTE -->
<div class="balance-card">
  <div class="balance-label">ðŸ’° Ã‰pargne automatique intelligente</div>
  <div class="balance-amount" id="savings">0 Ar</div>
  <div class="balance-label" id="savingsRuleText">
    Une partie de chaque revenu est Ã©pargnÃ©e automatiquement tout en gardant un reste Ã  vivre minimum.
  </div>
</div>

<!-- STATS -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-label">Revenus</div>
    <div class="stat-value positive" id="income">0 Ar</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">DÃ©penses</div>
    <div class="stat-value negative" id="expenses">0 Ar</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Transactions</div>
    <div class="stat-value" id="count">0</div>
  </div>
</div>

<div class="actions">
  <button class="btn btn-primary" onclick="openModal()">âž• Ajouter</button>
  <button class="btn btn-secondary" onclick="exportData()">ðŸ“Š Export</button>
  <button class="btn btn-secondary" onclick="resetData()">ðŸ§¹ RÃ©initialiser</button>
</div>

<input class="search-box" placeholder="ðŸ” Rechercher..." id="search" oninput="renderTransactions()">

<!-- SUGGESTIONS DE BUDGET -->
<div class="balance-card">
  <div class="balance-label">ðŸ’¡ Suggestions de budget</div>
  <p class="balance-label" id="suggestionText">
    Entrez votre budget mensuel pour voir une rÃ©partition conseillÃ©e (logement, nourriture, transport, Ã©pargne...).
  </p>
  <div id="suggestionList"></div>
</div>

<!-- ENVELOPPES CATEGORIES -->
<div class="envelopes">
  <h3 style="margin-bottom:8px;font-size:18px">Enveloppes par catÃ©gorie</h3>
  <div id="envelopesList"></div>
</div>

<!-- TRANSACTIONS -->
<div class="transactions">
  <h3>Transactions rÃ©centes</h3>
  <div id="transactionsList"></div>
</div>

</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h2>Nouvelle transaction</h2>
    <form onsubmit="addTransaction(event)">
      <div class="form-group">
        <label>Type</label>
        <select id="type" onchange="updateCategories()">
          <option value="expense">DÃ©pense</option>
          <option value="income">Revenu</option>
        </select>
      </div>

      <div class="form-group">
        <label>Montant (Ar)</label>
        <input type="number" id="amount" required>
      </div>

      <div class="form-group">
        <label>Description</label>
        <input type="text" id="description" required>
      </div>

      <div class="form-group">
        <label>CatÃ©gorie</label>
        <div class="category-grid" id="categories"></div>
      </div>

      <div style="display:flex;gap:10px;margin-top:8px">
        <button class="btn btn-primary">Valider</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
      </div>
    </form>
  </div>
</div>

<script>
// catÃ©gories de base
const categories = {
  expense:[
    {icon:'ðŸ”',name:'Nourriture',color:'#ff6b6b'},
    {icon:'ðŸš—',name:'Transport',color:'#4ecdc4'},
    {icon:'ðŸ ',name:'Logement',color:'#95e1d3'},
    {icon:'ðŸ“¶',name:'Internet',color:'#ffd93d'},
    {icon:'ðŸ’¡',name:'Ã‰nergie',color:'#f8b400'},
    {icon:'â¤ï¸',name:'SantÃ©',color:'#ff9ff3'},
    {icon:'ðŸŽ‰',name:'Loisirs',color:'#a29bfe'},
    {icon:'ðŸ›ï¸',name:'Achats',color:'#ff8b94'}
  ],
  income:[
    {icon:'ðŸ’°',name:'Salaire',color:'#4ecdc4'},
    {icon:'ðŸ“ˆ',name:'Business',color:'#ffd93d'},
    {icon:'ðŸŽ',name:'Autre',color:'#95e1d3'}
  ]
};

// rÃ¨gles de budget par catÃ©gorie (portion du budget total)
const budgetRules = {
  'Logement': 0.35,
  'Nourriture': 0.25,
  'Transport': 0.10,
  'Autres essentiels': 0.10,
  'Loisirs': 0.10,
  'Ã‰pargne': 0.10
};

const MIN_RESTE_A_VIVRE = 50000;  // reste minimum Ã  garder
const MAX_SAVINGS_RATE = 0.2;     // 20 % max du revenu

let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
let savings = parseFloat(localStorage.getItem('savings') || '0');
let selectedCategory = null;

let monthlyBudget = Number(localStorage.getItem('monthlyBudget') || 0);
let peopleCount = Number(localStorage.getItem('peopleCount') || 1);

function formatAr(v){return new Intl.NumberFormat('fr-FR').format(v)+' Ar'}

function updateCategories(){
  const type = document.getElementById('type').value;
  const grid = document.getElementById('categories');
  grid.innerHTML = categories[type].map((c,i)=>
    `<div class="category-btn" onclick="selectCategory(${i})" title="${c.name}">${c.icon}</div>`
  ).join('');
  selectedCategory = null;
}

function selectCategory(i){
  document.querySelectorAll('.category-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.category-btn')[i].classList.add('active');
  selectedCategory = i;
}

function addTransaction(e){
  e.preventDefault();
  const type = document.getElementById('type').value;
  const amount = Number(document.getElementById('amount').value);
  const desc = document.getElementById('description').value;

  if(selectedCategory === null){alert('Choisissez une catÃ©gorie');return;}

  const cat = categories[type][selectedCategory];
  const value = type === 'expense' ? -amount : amount;

  const currentBalance = transactions.reduce((s,t)=>s+t.amount,0);
  const projectedBalance = currentBalance + value;

  if(type === 'income'){
    const maxSavingsForThisIncome = amount * MAX_SAVINGS_RATE;
    const possibleSavings = Math.max(0, maxSavingsForThisIncome);
    const balanceAfterSaving = projectedBalance - possibleSavings;

    let effectiveSavings = 0;

    if(balanceAfterSaving >= MIN_RESTE_A_VIVRE){
      effectiveSavings = possibleSavings;
    } else {
      const difference = MIN_RESTE_A_VIVRE - balanceAfterSaving;
      effectiveSavings = Math.max(0, possibleSavings - difference);
    }

    savings += effectiveSavings;

    transactions.unshift({
      id: Date.now(),
      amount: value - effectiveSavings,
      description: desc + (effectiveSavings>0?' (aprÃ¨s Ã©pargne)':''),
      icon: cat.icon,
      category: cat.name,
      color: cat.color,
      date: new Date()
    });

  } else {
    transactions.unshift({
      id: Date.now(),
      amount: value,
      description: desc,
      icon: cat.icon,
      category: cat.name,
      color: cat.color,
      date: new Date()
    });
  }

  localStorage.setItem('savings', savings);
  localStorage.setItem('transactions', JSON.stringify(transactions));
  closeModal();
  renderTransactions();
  updateStats();
  renderEnvelopes();
}

function renderTransactions(){
  const s = document.getElementById('search').value.toLowerCase();
  const list = document.getElementById('transactionsList');
  list.innerHTML = transactions
    .filter(t=>t.description.toLowerCase().includes(s) || t.category.toLowerCase().includes(s))
    .map(t=>`
    <div class="transaction-item" onclick="deleteTransaction(${t.id})">
      <div class="transaction-info">
        <div class="transaction-icon" style="background:${t.color}20">${t.icon}</div>
        <div>
          ${t.description}<br>
          <small>${t.category} Â· ${new Date(t.date).toLocaleDateString()}</small>
        </div>
      </div>
      <div class="transaction-amount" style="color:${t.amount>0?'#4ecdc4':'#ff6b6b'}">
        ${t.amount>0?'+':''}${formatAr(Math.abs(t.amount))}
      </div>
    </div>`).join('') || '<p>Aucune transaction</p>';
}

function updateStats(){
  const balance = transactions.reduce((s,t)=>s+t.amount,0);
  const income = transactions.filter(t=>t.amount>0).reduce((s,t)=>s+t.amount,0);
  const expenses = Math.abs(transactions.filter(t=>t.amount<0).reduce((s,t)=>s+t.amount,0));

  balanceEl.textContent = formatAr(balance);
  incomeEl.textContent = formatAr(income);
  expensesEl.textContent = formatAr(expenses);
  countEl.textContent = transactions.length;
  savingsEl.textContent = formatAr(savings);
}

function deleteTransaction(id){
  if(confirm('Supprimer cette transaction ?')){
    transactions = transactions.filter(t=>t.id!==id);
    localStorage.setItem('transactions',JSON.stringify(transactions));
    renderTransactions();
    updateStats();
    renderEnvelopes();
  }
}

function openModal(){modal.style.display='flex';updateCategories()}
function closeModal(){modal.style.display='none'}

function toggleTheme(){
  document.body.classList.toggle('light');
}

function exportData(){
  const blob=new Blob([JSON.stringify({transactions,savings,monthlyBudget,peopleCount},null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='budget-pro.json';
  a.click();
}

function resetData(){
  if(confirm('RÃ©initialiser toutes les donnÃ©es ?')){
    transactions = [];
    savings = 0;
    monthlyBudget = 0;
    peopleCount = 1;
    localStorage.clear();
    document.getElementById('monthlyBudget').value = '';
    document.getElementById('peopleCount').value = 1;
    renderTransactions();
    updateStats();
    updateBudgetAdvice();
    renderSuggestions();
    renderEnvelopes();
  }
}

// CONFIG FOYER & SUGGESTIONS
function saveConfig(){
  monthlyBudget = Number(document.getElementById('monthlyBudget').value || 0);
  peopleCount = Number(document.getElementById('peopleCount').value || 1);
  localStorage.setItem('monthlyBudget', monthlyBudget);
  localStorage.setItem('peopleCount', peopleCount);
  updateBudgetAdvice();
  renderSuggestions();
  renderEnvelopes();
}

// conseil nourriture
function updateBudgetAdvice(){
  const foodBudget = monthlyBudget * 0.3;
  const perPerson = peopleCount > 0 ? foodBudget / peopleCount : 0;
  const el = document.getElementById('foodAdvice');
  if(!el) return;
  el.textContent = peopleCount > 0 && monthlyBudget > 0
    ? `${formatAr(foodBudget)} au total, soit environ ${formatAr(Math.round(perPerson))} par personne`
    : 'Entrez votre budget et le nombre de personnes';
}

// suggestions globales
function getSuggestions(){
  if(!monthlyBudget || monthlyBudget <= 0){
    return null;
  }
  const suggestions = {};
  let totalAssigned = 0;
  for(const cat in budgetRules){
    const amount = Math.round(monthlyBudget * budgetRules[cat]);
    suggestions[cat] = amount;
    totalAssigned += amount;
  }
  const diff = monthlyBudget - totalAssigned;
  suggestions['Ã‰pargne'] = (suggestions['Ã‰pargne'] || 0) + diff;
  return suggestions;
}

function renderSuggestions(){
  const container = document.getElementById('suggestionList');
  const text = document.getElementById('suggestionText');
  if(!container || !text) return;

  const suggestions = getSuggestions();

  if(!suggestions){
    text.textContent = 'Entrez votre budget mensuel pour voir une rÃ©partition conseillÃ©e.';
    container.innerHTML = '';
    return;
  }

  text.textContent = `Voici une rÃ©partition indicative de votre budget de ${formatAr(monthlyBudget)} :`;

  const rows = Object.entries(suggestions).map(([cat, amount])=>{
    return `
      <div class="transaction-item" style="margin-bottom:6px;background:rgba(255,255,255,0.03);cursor:default">
        <div class="transaction-info">
          <strong>${cat}</strong>
        </div>
        <div class="transaction-amount">
          ${formatAr(amount)}
        </div>
      </div>
    `;
  }).join('');

  container.innerHTML = rows;
}

// enveloppes reliÃ©es aux dÃ©penses rÃ©elles
function getCategoryStats(){
  const suggestions = getSuggestions();
  const result = {};

  if(suggestions){
    if(suggestions['Nourriture']) result['Nourriture'] = {allocated: suggestions['Nourriture'], spent: 0};
    if(suggestions['Transport']) result['Transport'] = {allocated: suggestions['Transport'], spent: 0};
    if(suggestions['Logement']) result['Logement'] = {allocated: suggestions['Logement'], spent: 0};
  }

  transactions.forEach(t=>{
    if(t.amount < 0){
      const cat = t.category;
      const spent = Math.abs(t.amount);
      if(result[cat]){
        result[cat].spent += spent;
      }
    }
  });

  return result;
}

function renderEnvelopes(){
  const container = document.getElementById('envelopesList');
  if(!container) return;

  const stats = getCategoryStats();
  const keys = Object.keys(stats);

  if(keys.length === 0 || !monthlyBudget){
    container.innerHTML = '<p class="balance-label">Les enveloppes apparaÃ®tront ici lorsque vous aurez dÃ©fini un budget et ajoutÃ© des dÃ©penses.</p>';
    return;
  }

  container.innerHTML = keys.map(cat=>{
    const {allocated, spent} = stats[cat];
    const remaining = allocated - spent;
    const over = remaining < 0;
    return `
      <div class="envelope-row">
        <div>
          <div class="envelope-name">${cat}</div>
          ${over ? `<div class="envelope-warning">Vous avez dÃ©passÃ© lâ€™enveloppe de ${formatAr(Math.abs(remaining))}</div>` : ''}
        </div>
        <div class="envelope-amount">
          ${formatAr(spent)} / ${formatAr(allocated)}<br>
          <small>${over ? 'DÃ©passement' : 'Reste ' + formatAr(remaining)}</small>
        </div>
      </div>
    `;
  }).join('');
}

// Ã©lÃ©ments DOM
const balanceEl = document.getElementById('balance');
const incomeEl = document.getElementById('income');
const expensesEl = document.getElementById('expenses');
const countEl = document.getElementById('count');
const savingsEl = document.getElementById('savings');
const modal = document.getElementById('modal');

// init
document.getElementById('monthlyBudget').value = monthlyBudget || '';
document.getElementById('peopleCount').value = peopleCount || 1;

updateBudgetAdvice();
renderSuggestions();
renderTransactions();
updateStats();
renderEnvelopes();
</script>

</body>
</html>
